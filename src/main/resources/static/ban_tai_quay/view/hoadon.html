<div ng-controller="hoaDonCtrl">

    <h2 class="mb-3">Quản lý Hóa Đơn</h2>
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">

                <div class="col-md-6">
                    <input type="text"
                           class="form-control"
                           placeholder="Tìm theo mã hóa đơn / tên NV / tên KH"
                           ng-model="filter.keyword">
                </div>

                <div class="col-md-3">
                    <select class="form-select"
                            ng-model="filter.loaiHoaDon">
                        <option value="">-- Tất cả loại hóa đơn --</option>
                        <option value="1">Online</option>
                        <option value="0">Tại quầy</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100"
                            ng-click="resetFilter()">
                        Xóa lọc
                    </button>
                </div>

            </div>
        </div>
    </div>
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item" ng-repeat="tab in trangThaiTabs">
            <button type="button"
                    class="nav-link"
                    ng-class="{ active: trangThaiDangChon === tab.value }"
                    ng-click="chonTrangThai(tab.value)">
                {{tab.label}}
            </button>
        </li>
    </ul>


    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>STT</th>
            <th>Mã</th>
            <th>Nhân viên</th>
            <th>Khác hàng</th>
            <th>Ngày đặt</th>
            <th>Hóa Đơn</th>
            <th>Địa chỉ</th>
            <th>Trạng thái</th>
            <th>Hành Động</th>
        </tr>
        </thead>

        <tbody>
        <tr ng-repeat="hd in dsHoaDon | filter:filterHoaDon">
            <td>{{$index + 1}}</td>
            <td>{{hd.ma}}</td>
            <td>{{hd.tenNV}}</td>
            <td>{{hd.tenKH}}</td>
            <td>{{hd.ngayDatHang | date:'dd/MM/yyyy HH:mm'}}</td>

            <td>
                <span ng-if="hd.loaiHoaDon == 1" class="badge bg-success">Online</span>
                <span ng-if="hd.loaiHoaDon == 0" class="badge bg-secondary">Tại quầy</span>
            </td>

            <td>{{hd.diaChi}}</td>

            <td>
                <span ng-if="hd.trangThai == 0" class="badge bg-warning">Chờ thanh toán</span>
                <span ng-if="hd.trangThai == 1" class="badge bg-success">Hoàn thành</span>
                <span ng-if="hd.trangThai == 2" class="badge bg-primary">Chờ xác nhận</span>
                <span ng-if="hd.trangThai == 3" class="badge bg-primary">Đã xác nhận</span>
                <span ng-if="hd.trangThai == 4" class="badge bg-primary">Giao Hàng</span>
                <span ng-if="hd.trangThai == 5" class="badge bg-danger">Hủy</span>
            </td>
            <td class="text-center">
                <button class="btn btn-info btn-sm" ng-click="openHoaDonDetail(hd.id)">
                    Chi tiết
                </button>


            </td>
        </tr>
        </tbody>
    </table>


    <div class="modal fade" id="hoaDonDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title">Chi Tiết Đơn Hàng</h4>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" ng-if="hoaDonDangXem.loaiHoaDon != 0">

                    <div class="progress-icons d-flex justify-content-between position-relative">

                        <div class="step text-center"
                             ng-class="{'active': getStepIndex(hoaDonDangXem.trangThai) >= 0}">
                            <i class="bi bi-check-circle fs-3"></i>
                            <div>Tạo đơn</div>
                        </div>
                        <i class="bi bi-dash fs-1 mx-2"
                           ng-class="{'text-primary': getStepIndex(hoaDonDangXem.trangThai) >= 1, 'text-secondary': getStepIndex(hoaDonDangXem.trangThai) < 1}"></i>
                        <div class="step text-center"
                             ng-class="{'active': getStepIndex(hoaDonDangXem.trangThai) >= 1}">
                            <i class="bi bi-hourglass-split fs-3"></i>
                            <div>Chờ xác nhận</div>
                        </div>
                        <i class="bi bi-dash fs-1 mx-2"
                           ng-class="{'text-primary': getStepIndex(hoaDonDangXem.trangThai) >= 2, 'text-secondary': getStepIndex(hoaDonDangXem.trangThai) < 2}"></i>

                        <div class="step text-center"
                             ng-class="{'active': getStepIndex(hoaDonDangXem.trangThai) >= 2}">
                            <i class="bi bi-person-check fs-3"></i>
                            <div>Xác nhận</div>
                        </div>
                        <i class="bi bi-dash fs-1 mx-2"
                           ng-class="{'text-primary': getStepIndex(hoaDonDangXem.trangThai) >= 3, 'text-secondary': getStepIndex(hoaDonDangXem.trangThai) < 3}"></i>

                        <div class="step text-center"
                             ng-class="{'active': getStepIndex(hoaDonDangXem.trangThai) >= 3}">
                            <i class="bi bi-truck fs-3"></i>
                            <div>Giao hàng</div>
                        </div>
                        <i class="bi bi-dash fs-1 mx-2"
                           ng-class="{'text-primary': getStepIndex(hoaDonDangXem.trangThai) >= 4, 'text-secondary': getStepIndex(hoaDonDangXem.trangThai) < 4}"></i>

                        <div class="step text-center"
                             ng-class="{'active': getStepIndex(hoaDonDangXem.trangThai) >= 4}">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                            <div>Hoàn thành</div>
                        </div>

                        <div class="progress-line"></div>

                    </div>

                    <div class="progress-bar-container position-relative mt-2">
                        <div class="progress-bar" ng-style="{'width': getProgressWidth() + '%'}"></div>
                    </div>
                </div>
                <hr>
                <div ng-if="hoaDonDangXem.loaiHoaDon != 0">
                    <h5>Chuyển trạng thái</h5>
                </div>


                <div class="d-flex flex-wrap gap-2" ng-if="hoaDonDangXem.loaiHoaDon != 0">

                    <button class="btn"
                            ng-class="coTheChuyenTrangThai(hoaDonDangXem.trangThai, 2)
                            ? 'btn-warning'
                            : 'btn-outline-secondary'"
                            ng-disabled="!coTheChuyenTrangThai(hoaDonDangXem.trangThai, 2)"
                            ng-click="doiTrangThaiHoaDon(hoaDonDangXem, 2)">
                        Chờ xác nhận
                    </button>

                    <button class="btn"
                            ng-class="coTheChuyenTrangThai(hoaDonDangXem.trangThai, 3)
                            ? 'btn-info'
                            : 'btn-outline-secondary'"
                            ng-disabled="!coTheChuyenTrangThai(hoaDonDangXem.trangThai, 3)"
                            ng-click="doiTrangThaiHoaDon(hoaDonDangXem, 3)">
                        Xác nhận
                    </button>

                    <button class="btn"
                            ng-class="coTheChuyenTrangThai(hoaDonDangXem.trangThai, 4)
                            ? 'btn-primary'
                            : 'btn-outline-secondary'"
                            ng-disabled="!coTheChuyenTrangThai(hoaDonDangXem.trangThai, 4)"
                            ng-click="doiTrangThaiHoaDon(hoaDonDangXem, 4)">
                        Đang giao
                    </button>

                    <button class="btn"
                            ng-class="coTheChuyenTrangThai(hoaDonDangXem.trangThai, 1)
                            ? 'btn-success'
                            : 'btn-outline-secondary'"
                            ng-disabled="!coTheChuyenTrangThai(hoaDonDangXem.trangThai, 1)"
                            ng-click="doiTrangThaiHoaDon(hoaDonDangXem, 1)">
                        Hoàn thành
                    </button>

                    <button class="btn"
                            ng-class="coTheChuyenTrangThai(hoaDonDangXem.trangThai, 5)
                            ? 'btn-danger'
                            : 'btn-outline-secondary'"
                            ng-disabled="!coTheChuyenTrangThai(hoaDonDangXem.trangThai, 5)"
                            ng-click="doiTrangThaiHoaDon(hoaDonDangXem, 5)">
                        Hủy đơn
                    </button>

                </div>

                <hr>
                <h5>Thông Tin Đơn Hàng</h5>
                <div class="row mb-3">
                    <p>
                        Trạng thái:
                        <b>{{ trangThaiMap[hoaDonDangXem.trangThai] }}</b>
                    </p>

                    <p>Mã đơn: {{hoaDonDangXem.ma}}</p>
                    <p>Loại đơn: {{hoaDonDangXem.loaiHoaDon == 1 ? 'Online' : 'Tại quầy'}}</p>

                    <p>Phí VC: {{hoaDonDangXem.phiVanChuyen | number}} đ</p>
                    <p>Tổng tiền: {{hoaDonDangXem.tongTien + hoaDonDangXem.phiVanChuyen | number}} đ</p>
                    <p>Tiền được giảm: {{hoaDonDangXem.giamGia | number}} đ</p>
                    <p>Phải thanh toán: {{hoaDonDangXem.thanhTien | number}} đ</p>

                </div>

                <h5>Thông Tin Khách Hàng</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p>Tên KH: {{hoaDonDangXem .tenKH}}</p>
                        <p>SĐT: {{hoaDonDangXem .sdt}}</p>
                    </div>
                    <div class="col-md-6">
                        <p>Email: {{hoaDonDangXem .email}}</p>
                        <p>Địa chỉ: {{hoaDonDangXem.diaChi}}</p>
                    </div>
                </div>
                <h5>Chi Tiết Sản Phẩm</h5>
                <div ng-repeat="ct in dsHDCT" class="border rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <img ng-src="{{ct.img}}"
                                 class="img-fluid rounded"
                                 style="max-height:120px"
                                 alt="Ảnh sản phẩm">
                        </div>
                        <div class="col-md-9">
                            <div class="col-md-6">
                                <p><b>Sản phẩm:</b> {{ct.tenSanPham}}</p>
                                <p><b>Size:</b> {{ct.tenSize}}</p>
                                <p><b>Màu:</b> {{ct.tenMau}}</p>
                                <p><b>Thể loại:</b> {{ct.tenTL}}</p>
                            </div>

                            <div class="col-md-6">
                                <p><b>Chất liệu:</b> {{ct.tenCL}}</p>
                                <p><b>Thương hiệu:</b> {{ct.tenTH}}</p>
                                <p><b>Giá:</b> {{ct.giaBan | number}} đ</p>
                                <p><b>Số lượng:</b> {{ct.soLuong}}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!--                </div>-->

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Đóng
                    </button>
                </div>

            </div>
        </div>
    </div>


</div>


