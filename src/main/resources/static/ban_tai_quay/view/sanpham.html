<div ng-controller="sanPhamCtrl">

    <h2>Quản lý sản phẩm</h2>
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Tìm theo tên hoặc mã"
                   ng-model="searchText">
        </div>
    </div>
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success" ng-click="openAddModal()">
            ➕ Thêm sản phẩm
        </button>
    </div>
    <div class="alert alert-success alert-dismissible fade show"
         ng-if="successMessage">
        <i class="bi bi-check-circle-fill me-2"></i>
        {{ successMessage }}
    </div>
    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>STT</th>
            <th>Mã</th>
            <th>Tên sản phẩm</th>
            <th>Thương hiệu</th>
            <th>Chất liệu</th>
            <th>Thể loại</th>
            <th>Trạng thái</th>
            <th>Mô tả</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>

        <tr ng-repeat="sp in dsSanPham  | filter:customFilter">
            <td>{{getSTT($index)}}</td>
            <td>{{sp.ma}}</td>
            <td>{{sp.ten}}</td>
            <td>{{sp.tenThuongHieu}}</td>
            <td>{{sp.tenChatLieu}}</td>
            <td>{{sp.tenTheLoai}}</td>

            <td>
                <span ng-if="sp.trangThai == 1" class="badge bg-success">Đang bán</span>
                <span ng-if="sp.trangThai == 0" class="badge bg-secondary">Ngừng bán</span>
            </td>
            <td>{{sp.moTa}}</td>
            <td>

                <button class="btn btn-info btn-sm" ng-click="openUpdate(sp.id)">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-warning btn-sm mb-3"
                        ng-click="openCTSP(sp.id)">
                    <i class="bi bi-eye"></i>
                </button>


            </td>
        </tr>
        </tbody>
    </table>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Cập nhật sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control"
                               ng-model="editSanPham.ten">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Thương hiệu</label>
                        <select class="form-select"
                                ng-model="editSanPham.thuongHieuId"
                                ng-options="th.id as th.tenTH for th in dsThuongHieu">
                            <option value="">-- Chọn thương hiệu --</option>
                        </select>

                    </div>

                    <div class="mb-3">
                        <label class="form-label">Chất liệu</label>
                        <select class="form-select"
                                ng-model="editSanPham.chatLieuId"
                                ng-options="cl.id as cl.tenCL for cl in dsChatLieu">
                            <option value="">-- Chọn chất liệu --</option>
                        </select>

                    </div>

                    <div class="mb-3">
                        <label class="form-label">Thể loại</label>
                        <select class="form-select"
                                ng-model="editSanPham.theLoaiId"
                                ng-options="tl.id as tl.ten for tl in dsTheLoai">
                            <option value="">-- Chọn thể loại --</option>
                        </select>

                    </div>

                    <div class="mb-3">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" ng-model="editSanPham.trangThai">
                            <option ng-value="1">Hoạt động</option>
                            <option ng-value="0">Ngừng</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control"
                                  ng-model="editSanPham.moTa"
                                  rows="3"></textarea>
                    </div>
                    <div class="alert alert-danger" ng-if="errorMessage">
                        {{ errorMessage }}
                    </div>
                    <div class="alert alert-success" ng-if="successMessage">
                        {{ successMessage }}
                    </div>

                </div>

                <!-- FOOTER -->
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Đóng
                    </button>
                    <button class="btn btn-primary" ng-click="updateSanPham()">
                        Lưu thay đổi
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="ctspModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Danh sách sản phẩm chi tiết</h5>

                    <button class="btn btn-success ms-3"
                            ng-click="showAddCTSP = !showAddCTSP">
                        ➕ Thêm CTSP
                    </button>

                    <button type="button" class="btn-close btn-close-white"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-success mt-2" ng-if="ctspSuccess">
                        {{ctspSuccess}}
                    </div>
                    <table class="table table-sm table-bordered mb-3">
                        <thead class="table-secondary">
                        <tr>
                            <th>Mã</th>
                            <th>Ảnh</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Size</th>
                            <th>Màu</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>

                        </tr>
                        </thead>

                        <tbody>
                        <tr ng-repeat="ct in dsSPCT">
                            <td>{{ct.ma}}</td>
                            <td class="text-center">
                                <img ng-src="{{ct.img}}"
                                     style="width:60px;height:60px;object-fit:cover">
                            </td>
                            <td>{{ct.gia | number}}</td>
                            <td>{{ct.soLuong}}</td>
                            <td>{{ct.tenSize}}</td>
                            <td>{{ct.tenMau}}</td>
                            <td>
                            <span ng-if="ct.trangThai == 1"
                                  class="badge bg-success">Đang bán</span>
                                <span ng-if="ct.trangThai == 0"
                                      class="badge bg-secondary">Ngừng bán</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning"
                                        ng-click="openEditCTSP(ct.id)">
                                    ✏️ Sửa
                                </button>
                            </td>

                        </tr>
                        </tbody>
                    </table>

                    <div ng-show="showAddCTSP"
                         class="border rounded p-3 bg-light">

                        <h6 class="mb-3">
                            {{ isEditCTSP ? '✏️ Cập nhật chi tiết sản phẩm' : '➕ Thêm chi tiết sản phẩm' }}
                        </h6>


                        <div class="row">
                            <div class="col-md-3">
                                <label>Size</label>
                                <select class="form-select"
                                        ng-model="ctspForm.sizeId"
                                        ng-options="s.id as s.tenSZ for s in dsSize">
                                    <option value=""></option>
                                </select>

                            </div>

                            <div class="col-md-3">
                                <label>Màu</label>
                                <select class="form-select"
                                        ng-model="ctspForm.mauId"
                                        ng-options="m.id as m.tenM for m in dsMauSac">
                                    <option value=""></option>

                                </select>

                            </div>

                            <div class="col-md-3">
                                <label>Giá</label>
                                <input class="form-control" ng-model="ctspForm.gia">
                            </div>

                            <div class="col-md-3">
                                <label>Số lượng</label>
                                <input class="form-control" ng-model="ctspForm.soLuong">
                            </div>
                        </div>

                        <div class="mt-2">
                            <label>Ảnh</label>
                            <input type="file"
                                   file-change="onSelectImageCTSP(files)"
                                   class="form-control">


                        </div>

                        <img ng-if="ctspForm.preview"
                             ng-src="{{ctspForm.preview}}"
                             style="width:80px"
                             class="mt-2">

                        <div class="text-danger mt-2" ng-if="ctspError">
                            {{ctspError}}
                        </div>

                        <div class="mt-3 text-end">
                            <button class="btn btn-primary"
                                    ng-click="saveCTSP()">Lưu
                            </button>

                            <button class="btn btn-secondary"
                                    ng-click="cancelCTSP()">Hủy
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Thêm sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <h6 class="fw-bold text-primary mb-3">Thông tin sản phẩm</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tên sản phẩm</label>
                            <input type="text"
                                   class="form-control"
                                   ng-class="{'is-invalid': errorMessage && !newSanPham.ten }"
                                   ng-change="checkTenSanPham()"
                                   ng-model="newSanPham.ten">

                            <div class="invalid-feedback">
                                Tên sản phẩm không được để trống
                            </div>
                            <small class="text-danger" ng-if="tenTrung">
                                Tên sản phẩm đã tồn tại
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select"
                                    ng-model="newSanPham.trangThai">
                                <option ng-value="1">đang bán</option>
                                <option ng-value="0">Ngừng bán</option>
                            </select>

                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Thể loại</label>
                            <select class="form-select"
                                    ng-model="newSanPham.theLoai"
                                    ng-class="{'is-invalid': errorMessage && !newSanPham.theLoai}">
                                <option value="">-- Chọn thể loại --</option>
                                <option ng-repeat="tl in dsTheLoai" value="{{tl.id}}">
                                    {{tl.ten}}
                                </option>
                            </select>

                            <div class="invalid-feedback">
                                Vui lòng chọn thể loại
                            </div>

                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Chất liệu</label>
                            <select class="form-select"
                                    ng-model="newSanPham.chatLieu"
                                    ng-class="{'is-invalid': errorMessage && !newSanPham.chatLieu}">
                                <option value="">-- Chọn chất liệu --</option>
                                <option ng-repeat="cl in dsChatLieu" value="{{cl.id}}">
                                    {{cl.tenCL}}
                                </option>
                            </select>

                            <div class="invalid-feedback">
                                Vui lòng chọn chất liệu
                            </div>

                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Thương hiệu</label>
                            <select class="form-select"
                                    ng-model="newSanPham.thuongHieu"
                                    ng-class="{'is-invalid': errorMessage && !newSanPham.thuongHieu}">
                                <option value="">-- Chọn thương hiệu --</option>
                                <option ng-repeat="th in dsThuongHieu" value="{{th.id}}">
                                    {{th.tenTH}}
                                </option>
                            </select>

                            <div class="invalid-feedback">
                                Vui lòng chọn thương hiệu
                            </div>

                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control"
                                  ng-model="newSanPham.moTa"></textarea>
                    </div>

                    <hr>

                    <!-- ====== CHỌN SIZE ====== -->
                    <div class="mb-3"
                         ng-class="{'border border-danger rounded p-2': errorMessage && newSanPham.sizeIds.length === 0}">
                        <label class="form-label fw-bold">Size</label>

                        <div class="d-flex flex-wrap gap-3">
                            <label ng-repeat="s in dsSize">
                                <input type="checkbox"
                                       ng-checked="newSanPham.sizeIds.includes(s.id)"
                                       ng-click="toggleSize(s.id)">
                                {{s.tenSZ}}
                            </label>
                        </div>

                        <div class="text-danger small mt-1"
                             ng-if="errorMessage && newSanPham.sizeIds.length === 0">
                            Vui lòng chọn ít nhất 1 size
                        </div>
                    </div>


                    <!-- ====== CHỌN MÀU ====== -->
                    <div class="mb-3"
                         ng-class="{'border border-danger rounded p-2': errorMessage && newSanPham.mauIds.length === 0}">
                        <label class="form-label fw-bold">Màu sắc</label>

                        <div class="d-flex flex-wrap gap-3">
                            <label ng-repeat="m in dsMauSac">
                                <input type="checkbox"
                                       ng-checked="newSanPham.mauIds.includes(m.id)"
                                       ng-click="toggleMau(m.id)">
                                {{m.tenM}}
                            </label>
                        </div>

                        <div class="text-danger small mt-1"
                             ng-if="errorMessage && newSanPham.mauIds.length === 0">
                            Vui lòng chọn ít nhất 1 màu sắc
                        </div>
                    </div>


                    <!-- ====== DANH SÁCH CTSP ====== -->
                    <div class="mt-4" ng-if="newSanPham.ctspList.length > 0">

                        <h6 class="fw-bold text-success">
                            Danh sách sản phẩm chi tiết
                        </h6>

                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Màu</th>
                                <th>Size</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Ảnh</th>
                            </tr>
                            </thead>

                            <tbody>
                            <tr ng-repeat="ct in newSanPham.ctspList">
                                <td>
                                <span class="badge bg-danger">
                                    {{ct.tenMau}}
                                </span>
                                </td>
                                <td>
                                <span class="badge bg-primary">
                                    {{ct.tenSize}}
                                </span>
                                </td>
                                <td>
                                    <input type="number"
                                           class="form-control"
                                           ng-model="ct.gia"
                                           ng-class="{'is-invalid': errorMessage && (!ct.gia || ct.gia <= 0)}">

                                    <div class="invalid-feedback">
                                        Giá phải lớn hơn 0
                                    </div>

                                </td>
                                <td>
                                    <input type="number"
                                           class="form-control"
                                           ng-model="ct.soLuong"
                                           ng-class="{'is-invalid': errorMessage && ct.soLuong < 0}">

                                    <div class="invalid-feedback">
                                        Số lượng không hợp lệ
                                    </div>

                                </td>
                                <td>
                                    <input type="file"
                                           class="form-control"
                                           accept="image/*"
                                           ng-class="{'is-invalid': errorMessage && !ct.file}"
                                           file-change="onSelectImage(files, ct)">

                                    <div class="invalid-feedback">
                                        Vui lòng chọn ảnh
                                    </div>


                                    <img ng-if="ct.preview"
                                         ng-src="{{ct.preview}}"
                                         style="width:80px;height:80px;object-fit:cover;border-radius:5px;margin-top:5px">

                                </td>


                            </tr>
                            </tbody>
                        </table>

                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Hủy
                    </button>
                    <button class="btn btn-success"
                            ng-click="addSanPham()">
                        Lưu
                    </button>

                </div>

            </div>
        </div>
    </div>


</div>
